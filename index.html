<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Refactoring Diagnostic - Understanding Your Construction Process</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #7c3aed;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --focus: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Skip to main content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 1000;
        }

        .skip-link:focus {
            top: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text);
            background: var(--bg);
            padding: 20px;
        }

        /* Focus indicators */
        *:focus {
            outline: 3px solid var(--focus);
            outline-offset: 2px;
        }

        button:focus,
        a:focus,
        input:focus,
        [tabindex]:focus {
            outline: 3px solid var(--focus);
            outline-offset: 2px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        main {
            padding: 30px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        h3 {
            color: var(--secondary);
            margin: 25px 0 15px;
            font-size: 1.3em;
        }

        h4 {
            color: var(--text);
            margin: 20px 0 10px;
            font-size: 1.1em;
        }

        p {
            margin-bottom: 15px;
            color: var(--text-light);
        }

        /* Form accessibility */
        fieldset {
            border: none;
            padding: 0;
            margin: 0 0 30px 0;
        }

        legend {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 15px;
            color: var(--text);
        }

        .question-group {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }

        .question-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text);
        }

        /* Input styling */
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            border-color: var(--primary);
        }

        /* Accessible slider */
        .slider-container {
            margin: 20px 0;
        }

        .slider-wrapper {
            position: relative;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]:focus::-webkit-slider-thumb {
            box-shadow: 0 0 0 3px var(--focus);
        }

        input[type="range"]:focus::-moz-range-thumb {
            box-shadow: 0 0 0 3px var(--focus);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.9em;
            color: var(--text-light);
        }

        .slider-value {
            text-align: center;
            font-size: 1.2em;
            font-weight: 600;
            color: var(--primary);
            margin: 10px 0;
        }

        /* Accessible radio buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .radio-option:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .radio-option:has(input:checked) {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .radio-option:has(input:focus) {
            outline: 3px solid var(--focus);
            outline-offset: 2px;
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .radio-option label {
            cursor: pointer;
            margin: 0;
            flex: 1;
        }

        /* Visual feedback with accessible alternatives */
        .visual-feedback {
            margin: 30px 0;
            padding: 25px;
            background: white;
            border-radius: 8px;
            border: 2px solid var(--border);
        }

        .meter {
            margin: 20px 0;
        }

        .meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .meter-label {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-btn {
            background: var(--text-light);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8em;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .info-btn:hover {
            background: var(--primary);
        }

        .meter-explanation {
            font-size: 0.9em;
            color: var(--text-light);
            margin-top: 8px;
            padding: 10px;
            background: var(--bg);
            border-radius: 4px;
            display: none;
        }

        .meter-explanation.show {
            display: block;
        }

        .meter-bar {
            height: 30px;
            background: var(--border);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 600;
        }

        /* Accessible status badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin: 10px 0;
            border: 2px solid currentColor;
        }

        .status-badge.full { 
            background: #d1fae5; 
            color: #065f46;
            border-color: #065f46;
        }
        .status-badge.moderate { 
            background: #fef3c7; 
            color: #92400e;
            border-color: #92400e;
        }
        .status-badge.low { 
            background: #fee2e2; 
            color: #991b1b;
            border-color: #991b1b;
        }
        .status-badge.critical { 
            background: #fecaca; 
            color: #7f1d1d;
            border-color: #7f1d1d;
        }

        /* Accessible buttons */
        .btn {
            display: inline-block;
            padding: 12px 30px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn:focus {
            outline: 3px solid var(--focus);
            outline-offset: 3px;
        }

        .btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--text-light);
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: var(--text);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Accessible progress bar */
        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s ease;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Accessible alerts */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid;
        }

        .alert ul {
            margin: 10px 0 10px 20px;
        }

        .alert-info {
            background: #eff6ff;
            border-color: var(--primary);
            color: #1e40af;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: var(--warning);
            color: #92400e;
        }

        .alert-danger {
            background: #fef2f2;
            border-color: var(--danger);
            color: #991b1b;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: var(--success);
            color: #065f46;
        }

        .report-section {
            margin: 30px 0;
            padding: 25px;
            background: var(--bg);
            border-radius: 8px;
        }

        .priority-list {
            list-style: none;
            counter-reset: priority;
            padding-left: 0;
        }

        .priority-list li {
            counter-increment: priority;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 6px;
            border-left: 4px solid var(--primary);
            position: relative;
            padding-left: 50px;
        }

        .priority-list li::before {
            content: counter(priority);
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .checklist {
            list-style: none;
            padding-left: 0;
        }

        .checklist li {
            padding: 10px 10px 10px 35px;
            position: relative;
            margin: 8px 0;
        }

        .checklist li::before {
            content: "‚úì";
            position: absolute;
            left: 10px;
            color: var(--success);
            font-weight: 600;
        }

        .checklist li.warning::before {
            content: "‚ö†";
            color: var(--warning);
        }

        /* Accessible concept cards */
        .concept-card {
            margin: 15px 0;
            padding: 20px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }

        .concept-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .concept-card:focus {
            outline: 3px solid var(--focus);
            outline-offset: 2px;
        }

        .concept-card h3 {
            margin-top: 0;
        }

        dl {
            margin: 10px 0;
        }

        dt {
            font-weight: 600;
            margin-top: 10px;
        }

        dd {
            margin-left: 20px;
            margin-bottom: 10px;
            color: var(--text-light);
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --border: #000000;
                --text-light: #000000;
            }
            
            .btn {
                border: 2px solid currentColor;
            }
        }

        /* Print styles */
        @media print {
            body { background: white; }
            .container { box-shadow: none; }
            .btn { display: none; }
            .skip-link { display: none; }
            .section { display: block !important; }
            .section:not(#report) { display: none !important; }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            main { padding: 20px; }
            header { padding: 30px 20px; }
            header h1 { font-size: 1.5em; }
            .btn-group { flex-direction: column; }
            .btn { width: 100%; margin: 5px 0 !important; }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="container">
        <header role="banner">
            <h1>The Refactoring Diagnostic</h1>
            <p>Understanding Your Identity Construction Process</p>
        </header>

        <main id="main-content" role="main">
            <!-- Announcement region for screen readers -->
            <div aria-live="polite" aria-atomic="true" class="sr-only" id="announcements"></div>

            <!-- SECTION 1: Welcome -->
            <section class="section active" id="welcome" aria-labelledby="welcome-heading">
                <h2 id="welcome-heading">Welcome to the Refactoring Diagnostic</h2>
                
                <p>If you've been feeling exhausted, confused, hollow, or like you're "faking" your way through life‚Äî<strong>you're not broken</strong>. You might be in the middle of one of the most energy-expensive processes in human development: <strong>identity refactoring</strong>.</p>

                <!-- Target Audience -->
                <div class="alert alert-info" role="region" aria-labelledby="target-audience-heading">
                    <h3 id="target-audience-heading">Who This Tool Is For</h3>
                    
                    <h4>Primary Audience:</h4>
                    <p><strong>Adolescents and young adults (ages 15-25)</strong> currently going through intensive identity construction‚Äîquestioning childhood programming, experimenting with new roles, building self-authored identity.</p>
                    
                    <h4>Also Useful For:</h4>
                    <p>Anyone experiencing major life transitions that require identity reconstruction (career changes, coming out, emigration, recovery from trauma, major relationship changes). The concepts apply across ages, though the developmental framing is calibrated for adolescence.</p>
                    
                    <p><strong>Note:</strong> If you're past age 25, you've likely completed adolescent refactoring. Your results will reflect current life stress and capacity, not developmental phase. The capacity protection principles still apply at any age.</p>
                </div>

                <!-- What This Tool Does -->
                <div class="alert alert-success" role="region" aria-labelledby="what-you-get-heading">
                    <h3 id="what-you-get-heading">What This Tool Provides</h3>
                    
                    <h4>You'll Get:</h4>
                    <ul>
                        <li><strong>Real-time feedback</strong> showing your current energy, construction cost, and stress levels as you answer questions</li>
                        <li><strong>Personalized diagnostic report</strong> identifying your specific challenges right now</li>
                        <li><strong>Prioritized action items</strong> for what you need most urgently</li>
                        <li><strong>Mechanisms not just descriptions</strong>‚Äîunderstand WHY you're exhausted (thermodynamics, neuroscience, developmental biology)</li>
                        <li><strong>Validation</strong> that your struggle is structural, not personal failure</li>
                        <li><strong>Connection to course content</strong>‚Äîunderstand how to use Chapter 2 tools given your current capacity</li>
                    </ul>
                    
                    <h4>We'll Ask You About:</h4>
                    <ul>
                        <li>Sleep, nutrition, and basic biological capacity</li>
                        <li>Identity clarity and feelings of authenticity</li>
                        <li>Stress levels and emotional regulation</li>
                        <li>Support systems and environmental stability</li>
                    </ul>
                    
                    <h4>Time Required:</h4>
                    <p><strong>10-15 minutes</strong> for complete assessment plus personalized report</p>
                    
                    <h4>Privacy Guarantee:</h4>
                    <p>All data stays on your device. Nothing sent to servers. Optional local save only. You can delete at any time.</p>
                </div>

                <!-- Age Input -->
                <div class="question-group">
                    <label for="age-input">
                        <strong>Optional but Recommended:</strong> Your age helps us provide more relevant guidance
                    </label>
                    <input type="number" 
                           id="age-input" 
                           min="13" 
                           max="100" 
                           placeholder="Enter your age (or leave blank)"
                           aria-describedby="age-help">
                    <p id="age-help" style="font-size: 0.9em; color: var(--text-light); margin-top: 10px;">
                        This helps us interpret your results appropriately. For example:
                    </p>
                    <ul style="font-size: 0.9em; color: var(--text-light); margin-top: 5px;">
                        <li><strong>Ages 15-25:</strong> Report focuses on adolescent refactoring and brain development</li>
                        <li><strong>Ages 26-35:</strong> Report emphasizes post-refactoring maintenance and life transitions</li>
                        <li><strong>Ages 36+:</strong> Report focuses on capacity protection and life stress management</li>
                    </ul>
                </div>

                <!-- Navigation -->
                <nav aria-label="Main navigation">
                    <div class="btn-group">
                        <button type="button" class="btn" onclick="startAssessment()">
                            Start Assessment
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="showSection('concepts')">
                            Explore Concepts First
                        </button>
                    </div>
                </nav>
            </section>

            <!-- SECTION 2: Assessment -->
            <section class="section" id="assessment" aria-labelledby="assessment-heading">
                <h2 id="assessment-heading">Self-Assessment: Where Are You Right Now?</h2>
                
                <div role="progressbar" 
                     aria-valuenow="0" 
                     aria-valuemin="0" 
                     aria-valuemax="100"
                     aria-label="Assessment progress"
                     class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>
                <p style="text-align: center; color: var(--text-light);">
                    Question <span id="questionNum">1</span> of <span id="totalQuestions">15</span>
                </p>

                <form id="assessmentForm" onsubmit="return false;">
                    <div id="questions">
                        <!-- Questions will be dynamically inserted here -->
                    </div>
                </form>

                <div class="visual-feedback" id="liveFeedback" style="display: none;" role="region" aria-labelledby="live-feedback-heading">
                    <h3 id="live-feedback-heading">Your Current State (Live Update)</h3>
                    <p style="font-size: 0.9em; color: var(--text-light); margin-bottom: 20px;">
                        Click the <span aria-label="information icon">‚ÑπÔ∏è</span> buttons to understand what each meter measures.
                    </p>
                    
                    <div class="meter">
                        <div class="meter-header">
                            <div class="meter-label">
                                <span id="energy-label">Available Energy</span>
                                <button type="button" class="info-btn" aria-label="Explain available energy" onclick="toggleExplanation('energy')">‚ÑπÔ∏è</button>
                            </div>
                            <span id="energyPercent" aria-live="polite">--</span>
                        </div>
                        <div role="meter" 
                             aria-labelledby="energy-label"
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100"
                             class="meter-bar">
                            <div class="meter-fill" id="energyMeter" style="width: 0%">
                                <span class="sr-only" id="energy-sr">Energy level: 0%</span>
                            </div>
                        </div>
                        <div class="meter-explanation" id="energy-explanation">
                            <strong>What this measures:</strong> Your current cognitive capacity for complex thinking, emotional regulation, and ethical reasoning. Below 70% means reduced capacity; below 40% means approaching the tipping point where sophisticated analysis becomes physically impossible.
                        </div>
                    </div>

                    <div class="meter">
                        <div class="meter-header">
                            <div class="meter-label">
                                <span id="construction-label">Construction Cost</span>
                                <button type="button" class="info-btn" aria-label="Explain construction cost" onclick="toggleExplanation('construction')">‚ÑπÔ∏è</button>
                            </div>
                            <span id="constructionPercent" aria-live="polite">--</span>
                        </div>
                        <div role="meter" 
                             aria-labelledby="construction-label"
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100"
                             class="meter-bar">
                            <div class="meter-fill" id="constructionMeter" style="width: 0%; background: linear-gradient(90deg, #fbbf24, #f59e0b);">
                                <span class="sr-only" id="construction-sr">Construction cost: 0%</span>
                            </div>
                        </div>
                        <div class="meter-explanation" id="construction-explanation">
                            <strong>What this measures:</strong> Energy being used for identity work‚Äîquestioning values, experimenting with roles, managing the gap between old and new self. High cost is normal during major life transitions but depletes energy available for everything else.
                        </div>
                    </div>

                    <div class="meter">
                        <div class="meter-header">
                            <div class="meter-label">
                                <span id="heat-label">System Heat (Stress)</span>
                                <button type="button" class="info-btn" aria-label="Explain system heat" onclick="toggleExplanation('heat')">‚ÑπÔ∏è</button>
                            </div>
                            <span id="heatPercent" aria-live="polite">--</span>
                        </div>
                        <div role="meter" 
                             aria-labelledby="heat-label"
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100"
                             class="meter-bar">
                            <div class="meter-fill" id="heatMeter" style="width: 0%; background: linear-gradient(90deg, #f59e0b, #ef4444);">
                                <span class="sr-only" id="heat-sr">System heat: 0%</span>
                            </div>
                        </div>
                        <div class="meter-explanation" id="heat-explanation">
                            <strong>What this measures:</strong> Chronic stress from irritability, emotional dysregulation, impulsivity, and social pain. High heat forces your system into "cooling mode" (crashes, shutdowns) to prevent total collapse. Above 70% is dangerous territory.
                        </div>
                    </div>

                    <div class="alert alert-warning" id="statusWarning" role="alert" aria-live="assertive" style="display: none;">
                        <strong>System Alert:</strong> <span id="statusMessage"></span>
                    </div>
                </div>

                <nav aria-label="Assessment navigation">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="previousQuestion()" id="prevBtn" disabled>
                            <span aria-hidden="true">‚Üê</span> Previous
                        </button>
                        <button type="button" class="btn" onclick="nextQuestion()" id="nextBtn">
                            Next <span aria-hidden="true">‚Üí</span>
                        </button>
                    </div>
                </nav>
            </section>

            <!-- SECTION 3: Concepts -->
            <section class="section" id="concepts" aria-labelledby="concepts-heading">
                <h2 id="concepts-heading">Interactive Concept Explorer</h2>
                
                <p>Select any concept below to understand it through detailed explanation:</p>

                <button type="button" class="concept-card" onclick="showConcept('energy')" aria-describedby="energy-desc">
                    <h3>
                        <span aria-hidden="true">‚ö°</span>
                        The Energy Paradox
                    </h3>
                    <p id="energy-desc">Why you need massive energy to build identity, but building generates heat that drains your energy. Understanding the oscillation between productive bursts and crashes.</p>
                </button>

                <button type="button" class="concept-card" onclick="showConcept('depth')" aria-describedby="depth-desc">
                    <h3>
                        <span aria-hidden="true">üå≥</span>
                        Identity Depth Structure
                    </h3>
                    <p id="depth-desc">Your identity has layers: roots (biological), trunk (core values), branches (developing skills), and leading edge (immediate choices). Each changes at different rates and requires different energy.</p>
                </button>

                <button type="button" class="concept-card" onclick="showConcept('trough')" aria-describedby="trough-desc">
                    <h3>
                        <span aria-hidden="true">üåä</span>
                        The Entropic Trough
                    </h3>
                    <p id="trough-desc">Why you feel hollow: the gap between demolishing old identity and building new one. Understanding the five stages from childhood stability to adult self-authorship.</p>
                </button>

                <button type="button" class="concept-card" onclick="showConcept('masking')" aria-describedby="masking-desc">
                    <h3>
                        <span aria-hidden="true">üé≠</span>
                        The Cost of Masking
                    </h3>
                    <p id="masking-desc">Running two operating systems at once: how pretending to be someone you're not exhausts you. Why authenticity is thermodynamic efficiency, not luxury.</p>
                </button>

                <nav aria-label="Concept navigation">
                    <div class="btn-group">
                        <button type="button" class="btn" onclick="showSection('assessment')">
                            Take Assessment
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="showSection('welcome')">
                            <span aria-hidden="true">‚Üê</span> Back to Welcome
                        </button>
                    </div>
                </nav>
            </section>

            <!-- SECTION 4: Detailed Concept Views -->
            <section class="section" id="concept-detail" aria-labelledby="concept-detail-heading">
                <h2 id="concept-detail-heading">Concept Explanation</h2>
                <div id="conceptContent">
                    <!-- Dynamic content inserted here -->
                </div>
                <nav aria-label="Concept navigation">
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="showSection('concepts')">
                            <span aria-hidden="true">‚Üê</span> Back to Concepts
                        </button>
                    </div>
                </nav>
            </section>

            <!-- SECTION 5: Report -->
            <section class="section" id="report" aria-labelledby="report-heading">
                <h2 id="report-heading">Your Personalized Diagnostic Report</h2>
                
                <div class="report-section" id="reportSummary">
                    <!-- Will be populated with results -->
                </div>

                <nav aria-label="Report actions">
                    <div class="btn-group">
                        <button type="button" class="btn" onclick="window.print()">
                            <span aria-hidden="true">üñ®Ô∏è</span> Print Report
                        </button>
                        <button type="button" class="btn" onclick="saveResults()">
                            <span aria-hidden="true">üíæ</span> Save Results
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="startOver()">
                            <span aria-hidden="true">üîÑ</span> Start Over
                        </button>
                    </div>
                </nav>
            </section>
        </main>
    </div>

    <script>
        // Assessment Questions (unchanged from before)
        const questions = [
            {
                id: 'sleep',
                category: 'energy',
                text: 'How many hours of sleep did you get last night?',
                type: 'slider',
                min: 0,
                max: 12,
                default: 7,
                unit: 'hours',
                labels: ['0 hours', '12 hours'],
                score: (val) => {
                    if (val >= 7 && val <= 9) return 100;
                    if (val >= 6 && val < 7) return 70;
                    if (val >= 5 && val < 6) return 40;
                    return 20;
                }
            },
            {
                id: 'meals',
                category: 'energy',
                text: 'When did you last eat a real meal (not just snacks)?',
                type: 'radio',
                options: [
                    { text: 'Within the last 3-4 hours', value: 100 },
                    { text: '5-6 hours ago', value: 70 },
                    { text: 'Haven\'t eaten yet today', value: 40 },
                    { text: 'I regularly skip meals', value: 20 }
                ]
            },
            {
                id: 'exhaustion',
                category: 'energy',
                text: 'How exhausted do you feel right now?',
                type: 'slider',
                min: 0,
                max: 10,
                default: 5,
                unit: '',
                labels: ['Not at all exhausted', 'Completely exhausted'],
                score: (val) => 100 - (val * 10)
            },
            {
                id: 'identity_clarity',
                category: 'construction',
                text: 'I feel like I know who I am',
                type: 'slider',
                min: 1,
                max: 10,
                default: 5,
                unit: '',
                labels: ['Strongly disagree', 'Strongly agree'],
                score: (val) => val * 10
            },
            {
                id: 'feeling_fake',
                category: 'construction',
                text: 'I feel fake or hollow when playing my usual roles',
                type: 'slider',
                min: 1,
                max: 10,
                default: 5,
                unit: '',
                labels: ['Never feel fake', 'Always feel fake'],
                score: (val) => 100 - (val * 10)
            },
            {
                id: 'values_alignment',
                category: 'construction',
                text: 'My values match my family\'s values',
                type: 'slider',
                min: 1,
                max: 10,
                default: 5,
                unit: '',
                labels: ['Not at all', 'Completely match'],
                score: (val) => val * 10
            },
            {
                id: 'future_vision',
                category: 'construction',
                text: 'I can imagine my future self clearly',
                type: 'slider',
                min: 1,
                max: 10,
                default: 5,
                unit: '',
                labels: ['Not at all clear', 'Very clearly'],
                score: (val) => val * 10
            },
            {
                id: 'questioning',
                category: 'construction',
                text: 'I\'m questioning things I used to accept without thinking',
                type: 'radio',
                options: [
                    { text: 'Yes, constantly questioning', value: 100 },
                    { text: 'Sometimes questioning', value: 70 },
                    { text: 'Rarely questioning', value: 40 },
                    { text: 'No, not really questioning', value: 20 }
                ]
            },
            {
                id: 'irritability',
                category: 'heat',
                text: 'I snap at people over small things',
                type: 'radio',
                options: [
                    { text: 'Multiple times per day', value: 20 },
                    { text: 'Once a day or every few days', value: 40 },
                    { text: 'Occasionally', value: 70 },
                    { text: 'Rarely or never', value: 100 }
                ]
            },
            {
                id: 'disconnection',
                category: 'heat',
                text: 'I feel hollow or disconnected from myself',
                type: 'radio',
                options: [
                    { text: 'Most of the time', value: 20 },
                    { text: 'Often', value: 40 },
                    { text: 'Sometimes', value: 70 },
                    { text: 'Rarely', value: 100 }
                ]
            },
            {
                id: 'impulsivity',
                category: 'heat',
                text: 'I act impulsively then regret it',
                type: 'radio',
                options: [
                    { text: 'Very frequently', value: 20 },
                    { text: 'Often', value: 40 },
                    { text: 'Sometimes', value: 70 },
                    { text: 'Rarely', value: 100 }
                ]
            },
            {
                id: 'social_pain',
                category: 'heat',
                text: 'Social rejection feels physically painful',
                type: 'slider',
                min: 1,
                max: 10,
                default: 5,
                unit: '',
                labels: ['Not really painful', 'Extremely painful'],
                score: (val) => 100 - ((val - 1) * 11)
            },
            {
                id: 'authenticity',
                category: 'support',
                text: 'I have people I can be completely authentic with',
                type: 'radio',
                options: [
                    { text: 'Yes, multiple people', value: 100 },
                    { text: 'One or two people', value: 70 },
                    { text: 'Maybe one person', value: 40 },
                    { text: 'No one', value: 20 }
                ]
            },
            {
                id: 'stability',
                category: 'support',
                text: 'I have stable housing and food security',
                type: 'radio',
                options: [
                    { text: 'Yes, very stable', value: 100 },
                    { text: 'Mostly stable', value: 70 },
                    { text: 'Somewhat unstable', value: 40 },
                    { text: 'Very unstable', value: 20 }
                ]
            },
            {
                id: 'acceptance',
                category: 'support',
                text: 'My environment accepts who I\'m becoming',
                type: 'slider',
                min: 1,
                max: 10,
                default: 5,
                unit: '',
                labels: ['Not at all accepting', 'Completely accepting'],
                score: (val) => val * 10
            }
        ];

        // State management
        let currentQuestionIndex = 0;
        let responses = {};
        let userAge = null;

        // Announce to screen readers
        function announce(message) {
            const announcer = document.getElementById('announcements');
            announcer.textContent = message;
        }

        function toggleExplanation(meterId) {
            const explanation = document.getElementById(meterId + '-explanation');
            const isShown = explanation.classList.contains('show');
            
            // Hide all explanations
            document.querySelectorAll('.meter-explanation').forEach(el => {
                el.classList.remove('show');
            });
            
            // Toggle the clicked one
            if (!isShown) {
                explanation.classList.add('show');
                announce('Showing explanation for ' + meterId);
            }
        }

        function startAssessment() {
            // Capture age if provided
            const ageInput = document.getElementById('age-input');
            if (ageInput.value) {
                userAge = parseInt(ageInput.value);
            }
            
            showSection('assessment');
            announce('Starting assessment. Question 1 of ' + questions.length);
            renderQuestion(0);
        }

        function renderQuestion(index) {
            const question = questions[index];
            let questionHTML = '';
            
            if (question.type === 'slider') {
                questionHTML = `
                    <fieldset class="question-group">
                        <legend id="question-${question.id}-label">${question.text}</legend>
                        ${renderSlider(question)}
                    </fieldset>
                `;
            } else {
                questionHTML = `
                    <fieldset class="question-group">
                        <legend id="question-${question.id}-label">${question.text}</legend>
                        ${renderRadio(question)}
                    </fieldset>
                `;
            }
            
            document.getElementById('questions').innerHTML = questionHTML;
            document.getElementById('questionNum').textContent = index + 1;
            document.getElementById('totalQuestions').textContent = questions.length;
            
            const progress = ((index + 1) / questions.length * 100);
            document.getElementById('progressBar').style.width = progress + '%';
            document.querySelector('.progress-bar').setAttribute('aria-valuenow', progress);
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = index === 0;
            
            // Show live feedback after first few questions
            if (index >= 3) {
                document.getElementById('liveFeedback').style.display = 'block';
                updateLiveFeedback();
            }

            // Update button text for last question
            if (index === questions.length - 1) {
                document.getElementById('nextBtn').innerHTML = 'View Results <span aria-hidden="true">‚Üí</span>';
            } else {
                document.getElementById('nextBtn').innerHTML = 'Next <span aria-hidden="true">‚Üí</span>';
            }

            // Focus on the first input element
            setTimeout(() => {
                const firstInput = document.querySelector('#questions input');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        function renderSlider(question) {
            const savedValue = responses[question.id] !== undefined ? responses[question.id] : question.default;
            return `
                <div class="slider-container">
                    <div class="slider-value" id="slider-value-${question.id}" aria-live="polite">
                        ${savedValue}${question.unit ? ' ' + question.unit : ''}
                    </div>
                    <div class="slider-wrapper">
                        <input type="range" 
                               min="${question.min}" 
                               max="${question.max}" 
                               value="${savedValue}"
                               step="1"
                               id="slider-${question.id}"
                               aria-labelledby="question-${question.id}-label"
                               aria-valuemin="${question.min}"
                               aria-valuemax="${question.max}"
                               aria-valuenow="${savedValue}"
                               aria-valuetext="${savedValue}${question.unit ? ' ' + question.unit : ''}"
                               oninput="updateSlider('${question.id}', this.value, '${question.unit || ''}')"
                               onchange="saveResponse('${question.id}', parseFloat(this.value))">
                    </div>
                    <div class="slider-labels" aria-hidden="true">
                        <span>${question.labels[0]}</span>
                        <span>${question.labels[1]}</span>
                    </div>
                    <p class="sr-only">Use arrow keys to adjust the value between ${question.min} and ${question.max}</p>
                </div>
            `;
        }

        function renderRadio(question) {
            let html = '<div class="radio-group" role="radiogroup" aria-labelledby="question-' + question.id + '-label">';
            question.options.forEach((option, i) => {
                const checked = responses[question.id] === option.value ? 'checked' : '';
                const optionId = `${question.id}-option-${i}`;
                html += `
                    <div class="radio-option">
                        <input type="radio" 
                               name="${question.id}" 
                               id="${optionId}"
                               value="${option.value}"
                               ${checked}
                               onchange="saveResponse('${question.id}', ${option.value})">
                        <label for="${optionId}">${option.text}</label>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function updateSlider(questionId, value, unit) {
            const displayValue = value + (unit ? ' ' + unit : '');
            document.getElementById(`slider-value-${questionId}`).textContent = displayValue;
            const slider = document.getElementById(`slider-${questionId}`);
            slider.setAttribute('aria-valuenow', value);
            slider.setAttribute('aria-valuetext', displayValue);
            saveResponse(questionId, parseFloat(value));
        }

        function saveResponse(questionId, value) {
            responses[questionId] = value;
            updateLiveFeedback();
        }

        function updateLiveFeedback() {
            const scores = calculateScores();
            
            // Update energy meter
            const energyPercent = Math.round(scores.energy);
            document.getElementById('energyMeter').style.width = energyPercent + '%';
            document.getElementById('energyPercent').textContent = energyPercent + '%';
            document.getElementById('energy-sr').textContent = 'Energy level: ' + energyPercent + '%';
            document.querySelector('.meter-bar[aria-labelledby="energy-label"]').setAttribute('aria-valuenow', energyPercent);
            
            // Update construction meter
            const constructionPercent = Math.round(scores.construction);
            document.getElementById('constructionMeter').style.width = constructionPercent + '%';
            document.getElementById('constructionPercent').textContent = constructionPercent + '%';
            document.getElementById('construction-sr').textContent = 'Construction cost: ' + constructionPercent + '%';
            document.querySelector('.meter-bar[aria-labelledby="construction-label"]').setAttribute('aria-valuenow', constructionPercent);
            
            // Update heat meter
            const heatPercent = Math.round(scores.heat);
            document.getElementById('heatMeter').style.width = heatPercent + '%';
            document.getElementById('heatPercent').textContent = heatPercent + '%';
            document.getElementById('heat-sr').textContent = 'System heat: ' + heatPercent + '%';
            document.querySelector('.meter-bar[aria-labelledby="heat-label"]').setAttribute('aria-valuenow', heatPercent);

            // Show warning if approaching critical levels
            const statusWarning = document.getElementById('statusWarning');
            const statusMessage = document.getElementById('statusMessage');
            
            if (scores.energy < 40) {
                statusWarning.style.display = 'block';
                statusMessage.textContent = 'Your energy level is approaching the tipping point. Priority: Rest and restoration.';
            } else if (scores.heat > 70) {
                statusWarning.style.display = 'block';
                statusMessage.textContent = 'System heat is very high. You may be approaching capacity collapse.';
            } else {
                statusWarning.style.display = 'none';
            }
        }

        function calculateScores() {
            let energySum = 0, energyCount = 0;
            let constructionSum = 0, constructionCount = 0;
            let heatSum = 0, heatCount = 0;
            let supportSum = 0, supportCount = 0;

            questions.forEach(q => {
                if (responses[q.id] !== undefined) {
                    let score;
                    if (q.type === 'slider' && q.score) {
                        score = q.score(responses[q.id]);
                    } else {
                        score = responses[q.id];
                    }

                    if (q.category === 'energy') {
                        energySum += score;
                        energyCount++;
                    } else if (q.category === 'construction') {
                        constructionSum += score;
                        constructionCount++;
                    } else if (q.category === 'heat') {
                        heatSum += score;
                        heatCount++;
                    } else if (q.category === 'support') {
                        supportSum += score;
                        supportCount++;
                    }
                }
            });

            return {
                energy: energyCount > 0 ? energySum / energyCount : 0,
                construction: constructionCount > 0 ? 100 - (constructionSum / constructionCount) : 0,
                heat: heatCount > 0 ? 100 - (heatSum / heatCount) : 0,
                support: supportCount > 0 ? supportSum / supportCount : 0
            };
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
                announce('Question ' + (currentQuestionIndex + 1) + ' of ' + questions.length);
            } else {
                generateReport();
                announce('Assessment complete. Generating your personalized report.');
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion(currentQuestionIndex);
                announce('Question ' + (currentQuestionIndex + 1) + ' of ' + questions.length);
            }
        }

        function generateReport() {
            const scores = calculateScores();
            const capacity = scores.energy;
            
            let capacityLevel, capacityClass;

            // Determine capacity level
            if (capacity >= 70) {
                capacityLevel = 'Full Capacity';
                capacityClass = 'full';
            } else if (capacity >= 40) {
                capacityLevel = 'Moderate Depletion';
                capacityClass = 'moderate';
            } else if (capacity >= 20) {
                capacityLevel = 'Significant Depletion';
                capacityClass = 'low';
            } else {
                capacityLevel = 'Critical - Past Tipping Point';
                capacityClass = 'critical';
            }

            // Age-appropriate phase determination
            let phase, phaseDescription;

            if (userAge && userAge < 18) {
                phase = "Early Refactoring Phase";
                phaseDescription = "You're in the initial stages of questioning childhood programming and beginning identity experimentation. High construction cost and energy demands are normal for this phase.";
            } else if (userAge && userAge >= 18 && userAge <= 22) {
                if (scores.construction > 70) {
                    phase = "Peak Refactoring (Entropic Trough)";
                    phaseDescription = "You're in the most intensive period of identity reconstruction‚Äîmaximum instability, highest energy cost. This is temporary and necessary. The hollow feeling should begin stabilizing within 1-3 years.";
                } else if (scores.construction > 40) {
                    phase = "Active Refactoring (Mid-Stage)";
                    phaseDescription = "You're actively building new identity architecture while questioning old programming. Energy costs remain high but you're making progress toward stabilization.";
                } else {
                    phase = "Active Identity Development";
                    phaseDescription = "You're in active identity development with moderate construction costs. Your scores suggest you're managing the developmental demands reasonably well.";
                }
            } else if (userAge && userAge >= 23 && userAge <= 26) {
                if (scores.construction > 60) {
                    phase = "Late-Stage Refactoring";
                    phaseDescription = "Final brain pruning and identity stabilization happening. Energy costs should begin declining as architecture solidifies over the next 1-3 years.";
                } else {
                    phase = "Early Stabilization";
                    phaseDescription = "Identity architecture solidifying. Capacity should be increasing as adolescent refactoring completes. Current challenges likely reflect life stress more than developmental phase.";
                }
            } else if (userAge && userAge > 26) {
                phase = "Post-Refactoring / Life Management";
                phaseDescription = "Adolescent identity refactoring is complete. Your current scores reflect life stress, capacity management, and possibly identity work around major life transitions rather than developmental phase. The principles of capacity protection still apply at every age.";
            } else {
                // No age given
                phase = "Current State Assessment";
                phaseDescription = "Your scores reflect your current capacity and stress levels. (Note: Providing your age would allow for more accurate developmental context and interpretation.)";
            }

            // Identify challenges
            let primaryChallenges = [];
            if (scores.heat > 60) primaryChallenges.push('High system heat (chronic stress)');
            if (scores.construction > 60) primaryChallenges.push('Intensive identity construction work');
            if (scores.support < 50) primaryChallenges.push('Insufficient support infrastructure');
            if (capacity < 50) primaryChallenges.push('Low available energy');

            // Generate accessible report HTML
            const reportHTML = `
                <div class="alert alert-info" role="region" aria-labelledby="current-state-heading">
                    <h3 id="current-state-heading">Your Current State</h3>
                    <dl style="display: grid; grid-template-columns: auto 1fr; gap: 15px; margin-top: 15px;">
                        ${userAge ? `<dt><strong>Age:</strong></dt><dd>${userAge} years old</dd>` : ''}
                        <dt><strong>Capacity Level:</strong></dt>
                        <dd><span class="status-badge ${capacityClass}">${capacityLevel}</span></dd>
                        <dt><strong>Current Phase:</strong></dt>
                        <dd><span class="status-badge moderate">${phase}</span></dd>
                        <dt><strong>Energy Score:</strong></dt>
                        <dd>${Math.round(capacity)}% available</dd>
                        <dt><strong>Construction Cost:</strong></dt>
                        <dd>${Math.round(scores.construction)}% of energy budget</dd>
                        <dt><strong>System Heat:</strong></dt>
                        <dd>${Math.round(scores.heat)}% stress load</dd>
                        <dt><strong>Support Level:</strong></dt>
                        <dd>${Math.round(scores.support)}% adequate support</dd>
                    </dl>
                </div>

                <section aria-labelledby="phase-context-heading">
                    <h3 id="phase-context-heading">What This Means for You</h3>
                    <p>${phaseDescription}</p>
                </section>

                <section aria-labelledby="whats-happening-heading">
                    <h3 id="whats-happening-heading">What's Happening Right Now</h3>
                    <ul class="checklist">
                        ${scores.construction > 60 ? '<li>You\'re actively questioning core values and beliefs (trunk-level audit)</li>' : ''}
                        ${scores.construction > 40 ? '<li>You\'re experimenting with new roles and identities (leading edge work)</li>' : ''}
                        ${scores.heat > 60 ? '<li class="warning">Your system heat is dangerously high (chronic stress overload)</li>' : ''}
                        ${capacity < 40 ? '<li class="warning">You\'re approaching or past the capacity tipping point (risk of collapse)</li>' : ''}
                        ${scores.support > 60 ? '<li>You have some support infrastructure in place</li>' : '<li class="warning">Support infrastructure is inadequate for current demands</li>'}
                        ${primaryChallenges.length > 0 ? '<li class="warning">Primary challenges: ' + primaryChallenges.join(', ') + '</li>' : ''}
                    </ul>
                </section>

                <section aria-labelledby="what-you-need-heading">
                    <h3 id="what-you-need-heading">What You Need Right Now (Prioritized)</h3>
                    <ol class="priority-list">
                        ${capacity < 40 ? '<li><strong>CRITICAL: Restore capacity immediately</strong><br>Sleep 8+ hours tonight. Eat three real meals tomorrow. Cancel non-essential commitments for 48 hours. You\'re past the tipping point where complex ethical analysis is possible. Chapter 2 tools won\'t work until you restore substrate.</li>' : ''}
                        ${scores.heat > 70 ? '<li><strong>Reduce system heat urgently</strong><br>Identify ONE major stressor and remove or reduce it this week. Find ONE space where you can be 100% authentic (no masking cost). Practice saying "I need a break" to someone safe. Your system is forcing cooling phases to prevent total collapse.</li>' : ''}
                        ${scores.support < 50 ? '<li><strong>Build cooling infrastructure</strong><br>Identify 2-3 people who can absorb some environmental stress (not add to it). Create one predictable, low-demand routine in your week. Consider professional counseling if available‚Äîthermodynamically, you need external heat sinks.</li>' : ''}
                        ${scores.construction > 70 && userAge && userAge <= 25 ? '<li><strong>Accept oscillation as developmentally normal</strong><br>Expect crashes after productive phases‚Äîthis is thermodynamic cycling, not failure. Plan recovery time into your schedule. Track energy patterns to predict when you need rest. The hollow feeling is temporary (1-3 years) but requires patience.</li>' : ''}
                        ${userAge && userAge > 25 && scores.construction > 60 ? '<li><strong>Recognize major life transition</strong><br>You\'re past adolescent refactoring but clearly undergoing significant identity reconstruction (career change? relationship change? loss?). The same principles apply: protect capacity, reduce heat, get support. This transition will complete.</li>' : ''}
                        <li><strong>Use Chapter 2 tools strategically</strong><br>${capacity >= 70 ? 'You have adequate capacity to engage fully with SAGE methodology and ethical frameworks. This is a good window for learning.' : capacity >= 40 ? 'You can use course tools but may need more breaks, simpler applications, and extra time. Focus on one concept at a time. Don\'t attempt complex multi-framework analysis yet.' : 'STOP: Your capacity is too depleted for complex ethical frameworks. Attempting them now will fail and increase frustration. Focus on substrate restoration first. Return to Chapter 2 when capacity is above 40%.'}</li>
                    </ol>
                </section>

                ${generateTimelineSection(userAge, scores)}

                <div class="alert ${capacity < 40 ? 'alert-danger' : capacity < 70 ? 'alert-warning' : 'alert-success'}" role="alert">
                    <h3>${capacity < 40 ? 'üö® Immediate Action Required' : capacity < 70 ? '‚ö†Ô∏è Proceed With Caution' : '‚úÖ You Can Proceed'}</h3>
                    <p>${capacity < 40 ? 'Your capacity is too depleted for complex ethical analysis. This is not a character flaw‚Äîit\'s biology. Prioritize rest and recovery before continuing with course material. You literally cannot use the tools effectively right now.' : capacity < 70 ? 'You can engage with course material but need to adjust expectations. Take frequent breaks. Focus on one concept at a time. Avoid multi-hour study sessions. Use simpler applications before attempting complex analysis.' : 'You have adequate capacity to engage fully with the course material. This is a good window for learning. Maintain self-care practices to keep capacity in this range.'}</p>
                </div>
            `;

            document.getElementById('reportSummary').innerHTML = reportHTML;
            showSection('report');
            
            // Focus on report heading
            setTimeout(() => {
                document.getElementById('report-heading').focus();
            }, 100);
        }

        function generateTimelineSection(age, scores) {
            if (age && age <= 25) {
                return `
                    <section aria-labelledby="timeline-heading">
                        <h3 id="timeline-heading">Developmental Timeline & Expectations</h3>
                        <ul>
                            <li><strong>Identity refactoring</strong> typically peaks around ages 18-22</li>
                            <li><strong>Brain pruning and myelination</strong> continue into mid-twenties</li>
                            <li><strong>Prefrontal cortex maturation</strong> completes around age 25-26</li>
                            <li><strong>Energy costs decline</strong> as identity architecture stabilizes</li>
                            <li><strong>Capacity increases significantly</strong> once refactoring completes</li>
                            <li><strong>The hollow feeling is temporary</strong>‚Äîconstruction will complete</li>
                        </ul>
                        ${age < 22 ? '<p><strong>For you specifically:</strong> You likely have ' + (22 - age) + '-' + (26 - age) + ' more years of active refactoring and brain development. The most intensive phase should ease within ' + Math.max(1, 22 - age) + '-' + Math.max(3, 25 - age) + ' years.</p>' : '<p><strong>For you specifically:</strong> You\'re in the late stages. Energy costs should begin declining noticeably over the next 1-3 years as your brain completes pruning and your identity solidifies.</p>'}
                    </section>
                `;
            } else if (age && age > 25) {
                return `
                    <section aria-labelledby="context-heading">
                        <h3 id="context-heading">Interpreting Your Results</h3>
                        <p>While adolescent identity refactoring is complete for you, the core concepts still apply:</p>
                        <ul>
                            <li><strong>Energy depletion</strong> can happen at any age from chronic stress, overwork, caregiving demands, or life crises</li>
                            <li><strong>Identity work</strong> continues throughout life during major transitions‚Äîcareer changes, relationship changes, loss, trauma recovery, coming out later in life, retirement, etc.</li>
                            <li><strong>Capacity limits</strong> are real at every age. The tipping point (around 20-30% available energy) still applies. Past that threshold, complex reasoning fails regardless of age.</li>
                            <li><strong>System heat</strong> (chronic stress) still forces cooling phases (crashes, burnout) to prevent total collapse</li>
                            <li><strong>Support infrastructure</strong> remains thermodynamically necessary‚Äîyou still need external heat sinks to manage environmental stress</li>
                        </ul>
                        <p>Your scores reflect <strong>current life stress and capacity management</strong>, not developmental phase. The recommendations above focus on capacity protection principles that apply at any age.</p>
                    </section>
                `;
            } else {
                return `
                    <section aria-labelledby="general-context-heading">
                        <h3 id="general-context-heading">Understanding Your Results</h3>
                        <p>Your scores reflect your current capacity, stress levels, and identity work demands. Providing your age would allow for more specific developmental context, but the core principles apply universally:</p>
                        <ul>
                            <li>Capacity protection is essential at any age and life stage</li>
                            <li>System heat requires cooling infrastructure (support systems)</li>
                            <li>Identity work during major transitions is energy-expensive</li>
                            <li>The tipping point (20-30% capacity) exists for everyone</li>
                        </ul>
                    </section>
                `;
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId);
            targetSection.classList.add('active');
            
            // Focus management
            const heading = targetSection.querySelector('h2');
            if (heading) {
                heading.setAttribute('tabindex', '-1');
                heading.focus();
            }
            
            // Announce section change
            const sectionName = heading ? heading.textContent : sectionId;
            announce('Now showing: ' + sectionName);
        }

        function showConcept(conceptType) {
            let content = '';
            
            if (conceptType === 'energy') {
                content = `
                    <h3>The Energy Paradox</h3>
                    <p>This is the thermodynamic crisis at the heart of identity refactoring:</p>
                    
                    <section aria-labelledby="paradox-explanation">
                        <h4 id="paradox-explanation">Understanding the Paradox</h4>
                        <p><strong>You need massive energy to build a new identity structure.</strong> The construction requires:</p>
                        <ul>
                            <li>Prefrontal cortex running in Manual Mode (expensive)</li>
                            <li>Emotional regulation during anxiety spikes (expensive)</li>
                            <li>Social experimentation and risk-taking (expensive)</li>
                            <li>Managing conflicts with parents and institutions (expensive)</li>
                            <li>Maintaining academic or work performance while building (expensive)</li>
                        </ul>
                        
                        <p><strong>But the construction process generates so much internal heat that your system has to divert energy away from construction just to cool itself down.</strong></p>
                        
                        <p>This is why you oscillate so dramatically. One day you're intensely creative‚Äîwriting, making art, having deep conversations, planning your future, feeling alive and purposeful. The next day you crash into what feels like lethargy or depression‚Äîyou can barely get out of bed, can't focus on anything, feel hollow and unmotivated.</p>
                        
                        <p><strong>You're not being inconsistent or lazy.</strong> You're experiencing the natural oscillation of a high-energy system managing its own heat.</p>
                    </section>

                    <section aria-labelledby="energy-states">
                        <h4 id="energy-states">The Two States</h4>
                        <dl>
                            <dt><strong>High-energy construction phase:</strong></dt>
                            <dd>Building intensely, generating massive heat, using all available energy. This feels productive, alive, purposeful‚Äîyou're making real progress.</dd>
                            
                            <dt><strong>Cooling phase (what feels like "safe mode"):</strong></dt>
                            <dd>All systems shut down except basic maintenance, energy diverted to cooling, forced rest to prevent total collapse. This feels like depression or shutdown but is actually protective.</dd>
                        </dl>
                        
                        <p>This oscillation isn't optional. It's how the system survives. When you feel yourself crashing into "safe mode," your body is protecting you from overheating past the point of no return.</p>
                        
                        <p><strong>The key insight:</strong> Plan for the oscillation. After a productive burst, schedule recovery time. Don't fight the crashes‚Äîuse them for genuine rest, not guilt.</p>
                    </section>

                    <div class="alert alert-info">
                        <p><strong>Practical Application:</strong> Track your energy patterns for two weeks. Notice the cycle. Once you can predict crashes, you can plan around them rather than being surprised and demoralized by them.</p>
                    </div>
                `;
            } else if (conceptType === 'depth') {
                content = `
                    <h3>Identity Depth Structure</h3>
                    <p>Your identity isn't flat‚Äîit exists in layers that change at different rates and require different energy to modify.</p>

                    <section aria-labelledby="layers-heading">
                        <h4 id="layers-heading">The Four Layers</h4>
                        
                        <article aria-labelledby="leading-edge-heading">
                            <h5 id="leading-edge-heading">Leading Edge (Fluid, Immediate)</h5>
                            <p><strong>What it is:</strong> What you're choosing RIGHT NOW. Changes minute-to-minute, hour-to-hour, day-to-day. Lowest energy to modify.</p>
                            <p><strong>Examples:</strong> Today's outfit, current mood, this conversation's tone, tonight's plans, how you respond to this moment</p>
                            <p><strong>Change difficulty:</strong> EASY when you have capacity. Shrinks dramatically when capacity fails.</p>
                        </article>

                        <article aria-labelledby="branches-heading">
                            <h5 id="branches-heading">Branches (Growing, Adapting)</h5>
                            <p><strong>What it is:</strong> Your developing capacities and relationships. Takes sustained time and attention to grow, but flexible and revisable.</p>
                            <p><strong>Examples:</strong> Skills you're learning, friendships forming, expertise developing, communities you're joining, your growing knowledge</p>
                            <p><strong>Change difficulty:</strong> MODERATE. Requires consistent effort over weeks, months, years. Can redirect but takes deliberate work.</p>
                        </article>

                        <article aria-labelledby="trunk-heading">
                            <h5 id="trunk-heading">Trunk (Established, But Revisable)</h5>
                            <p><strong>What it is:</strong> Core operating system installed during childhood. Your fundamental values, beliefs, assumptions, identity categories. Feels like "who you are."</p>
                            <p><strong>Examples:</strong> Religious beliefs, political identity, core moral values, gender identity, understanding of family duty, fundamental worldview</p>
                            <p><strong>Change difficulty:</strong> HARD. Requires sustained energy over months or years. This is what refactoring primarily targets‚Äîauditing and rewriting trunk code.</p>
                        </article>

                        <article aria-labelledby="roots-heading">
                            <h5 id="roots-heading">Roots (Deep, Slow-Changing)</h5>
                            <p><strong>What it is:</strong> Biological foundations and deepest history. Largely unchangeable without major intervention or generational time.</p>
                            <p><strong>Examples:</strong> Need for sleep, primary language and its cognitive patterns, early trauma responses, body's baseline stress reactivity, genetic predispositions</p>
                            <p><strong>Change difficulty:</strong> VERY HARD or impossible. Requires medical intervention, intensive therapy, or acceptance and adaptation.</p>
                        </article>
                    </section>

                    <div class="alert alert-warning">
                        <p><strong>Why this matters for capacity:</strong> When you're exhausted or stressed, you lose access to leading edge and branches. You revert to trunk and roots‚Äîthe oldest, simplest, most automatic programming. This is why you "become yourself" under pressure‚Äîyou fall back to the deepest, cheapest-to-run patterns.</p>
                    </div>

                    <section aria-labelledby="depth-applications">
                        <h4 id="depth-applications">Practical Applications</h4>
                        <ul>
                            <li><strong>When trying to change:</strong> Identify which layer you're targeting. Leading edge changes are quick; trunk changes require years and high capacity.</li>
                            <li><strong>When stressed:</strong> Recognize you've lost access to sophisticated layers. Don't judge yourself for reverting to simpler patterns‚Äîthat's protective, not failure.</li>
                            <li><strong>When misaligned:</strong> If leading edge (how you act) doesn't match trunk (who you are), you're burning energy on translation constantly. Find spaces where alignment is possible.</li>
                            <li><strong>When planning growth:</strong> Build branches (new skills, relationships) when you have moderate capacity. Save trunk revision (questioning core beliefs) for when you have high capacity and strong support.</li>
                        </ul>
                    </section>
                `;
            } else if (conceptType === 'trough') {
                content = `
                    <h3>The Entropic Trough</h3>
                    <p>The hollow feeling has a name and a purpose: you're in the gap between demolition and construction.</p>

                    <section aria-labelledby="stages-heading">
                        <h4 id="stages-heading">The Five Stages of Identity Development</h4>
                        
                        <ol>
                            <li>
                                <strong>Childhood (Stable but Borrowed):</strong>
                                You run programming installed by parents, culture, school, religion. Feels certain and real because you don't question it yet. This identity is stable but it's not yours‚Äîyou didn't choose it.
                            </li>
                            <li>
                                <strong>Demolition (Questioning Begins):</strong>
                                You start realizing: "Wait, is this really me? Do I actually believe this?" You're performing a necessary audit of childhood programming. Feels unsettling but is essential. Usually begins in mid-to-late adolescence.
                            </li>
                            <li>
                                <strong>The Gap / Entropic Trough (Maximum Instability):</strong>
                                You've loosened attachment to childhood identity but haven't stabilized the adult version yet. You feel hollow, fake, fragmented‚Äîlike you're performing rather than being. This is the most uncomfortable phase but you CANNOT skip it. Duration: typically 1-4 years at peak intensity.
                            </li>
                            <li>
                                <strong>Construction (Building New Architecture):</strong>
                                Actively building self-authored identity through experimentation. Energy-intensive but progress becomes visible. You're testing versions of yourself, keeping what fits, discarding what doesn't.
                            </li>
                            <li>
                                <strong>Stabilization / Adulthood (Owned Identity):</strong>
                                Identity solidifies into something that feels real AND chosen. Still revisable during major life transitions but no longer under constant reconstruction. Usually achieved by mid-to-late twenties.
                            </li>
                        </ol>
                    </section>

                    <div class="alert alert-success">
                        <p><strong>The key insight:</strong> The hollow feeling isn't you being broken. It's the space between versions. You've demolished the old house (childhood identity) but haven't finished building the new one (self-authored identity). Of course it feels unstable‚Äîyou're living in the construction zone.</p>
                        
                        <p><strong>What helps:</strong> Knowing this is temporary (1-4 years typically), having people who accept your "in-between" state, permission to experiment without commitment, recognizing small signs of progress.</p>
                        
                        <p><strong>What doesn't help:</strong> Forcing premature commitment ("just pick something!"), comparing yourself to people with stable borrowed identities, expecting yourself to function as if you had a finished foundation.</p>
                    </div>
                `;
            } else if (conceptType === 'masking') {
                content = `
                    <h3>The Cost of Masking</h3>
                    <p>When who you are doesn't match the role you have to play, you're running two operating systems simultaneously.</p>

                    <section aria-labelledby="translation-heading">
                        <h4 id="translation-heading">The Translation Process</h4>
                        <p>This happens hundreds of times per day in every interaction where you can't be authentic:</p>
                        
                        <dl style="background: var(--bg); padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <dt><strong>Input (from environment):</strong></dt>
                            <dd>"How are you doing?"</dd>
                            
                            <dt style="margin-top: 10px;"><strong>Internal Truth:</strong></dt>
                            <dd>"I'm exhausted, questioning everything about my life, barely holding it together, feel hollow and fake most of the time"</dd>
                            
                            <dt style="margin-top: 10px;"><strong>Required Output (what's safe to say):</strong></dt>
                            <dd>"Fine! How are you?"</dd>
                            
                            <dt style="margin-top: 10px;"><strong>Energy Cost:</strong></dt>
                            <dd>
                                <ul>
                                    <li>Suppressing internal truth</li>
                                    <li>Generating false performance</li>
                                    <li>Monitoring the gap between truth and performance</li>
                                    <li>Managing anxiety about being "found out"</li>
                                    <li>Remembering what you've told different people</li>
                                </ul>
                                <strong>Result: CONSTANT ENERGY DRAIN</strong>
                            </dd>
                        </dl>
                    </section>

                    <section aria-labelledby="why-exhausting-heading">
                        <h4 id="why-exhausting-heading">Why This Is So Exhausting</h4>
                        <p>Every conversation where you can't be authentic becomes a computational task:</p>
                        <ul>
                            <li><strong>At school/work:</strong> Hiding your real interests, beliefs, struggles, identity. Pretending to care about things that bore you. Performing enthusiasm, confidence, or normalcy you don't feel.</li>
                            <li><strong>With family:</strong> Playing the role of "good child" while internally being someone very different. Not correcting their assumptions about who you are.</li>
                            <li><strong>With peers:</strong> Experimenting with different performances to see what works. Code-switching between friend groups. Managing multiple "versions" of yourself.</li>
                        </ul>
                        
                        <p>That energy you're burning on translation and suppression? <strong>That's energy you needed for:</strong></p>
                        <ul>
                            <li>Actual learning and cognitive work</li>
                            <li>Identity construction (the work you're trying to do)</li>
                            <li>Emotional regulation</li>
                            <li>Physical health maintenance</li>
                            <li>Relationship building</li>
                            <li>Creative expression</li>
                        </ul>
                    </section>

                    <div class="alert alert-info">
                        <p><strong>Why authenticity is thermodynamic efficiency:</strong> Every space where you can be 100% yourself‚Äîno translation, no suppression, no monitoring‚Äîis energy you save for everything else. This is why finding even ONE place (one person, one community, one online space) where you don't have to perform is crucial.</p>
                        
                        <p><strong>Practical strategy:</strong> Identify your current "masking cost" by rating authenticity in different contexts (home, school, work, friends) on 0-100%. Calculate total daily masking time. Then: prioritize creating or finding at least ONE zero-masking-cost space. This becomes your energy recharge zone.</p>
                    </div>
                `;
            }

            document.getElementById('conceptContent').innerHTML = content;
            showSection('concept-detail');
        }

        function saveResults() {
            const data = {
                responses: responses,
                scores: calculateScores(),
                age: userAge,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('refactoring_results', JSON.stringify(data));
            announce('Results saved to your device successfully.');
            alert('Results saved to your device! You can return to this page later to review them.');
        }

        function startOver() {
            if (confirm('This will clear your current assessment and start over. Continue?')) {
                responses = {};
                currentQuestionIndex = 0;
                userAge = null;
                showSection('welcome');
                announce('Assessment reset. Returning to welcome screen.');
            }
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const currentSection = document.querySelector('.section.active');
                if (currentSection && currentSection.id === 'concept-detail') {
                    showSection('concepts');
                }
            }
        });

        // Initialize
        window.onload = function() {
            const saved = localStorage.getItem('refactoring_results');
            if (saved) {
                // Could show option to resume
            }
            
            document.getElementById('totalQuestions').textContent = questions.length;
        };
    </script>
</body>
</html>
